# 4.1 QR Code Connection

## Front-end Components

- **QRScanActivity**: Camera-based QR code scanning interface
  - PreviewView: Camera preview for QR code scanning
  - ImageButton back button: Navigation back to previous screen
  - TextView scanning status: Shows scanning progress/instructions

- **BarcodeScanner**: ML Kit barcode scanning client
  - QR code format detection: Specialized for QR code recognition
  - Real-time analysis: Continuous camera frame processing

- **CameraX**: Android Jetpack camera management
  - ProcessCameraProvider: Camera lifecycle management
  - ImageAnalysis: Real-time frame analysis for QR codes
  - Camera permissions: Runtime camera access handling

## Back-end Components

- **FirebaseDatabase**: Connection request management
  - Connection requests lookup: Validates scanned QR code data
  - Session ID validation: Ensures QR code corresponds to valid connection
  - Real-time request monitoring: Checks request status and acceptance

- **ConnectionRequestManager**: Manages connection request lifecycle
  - Active session tracking: Prevents duplicate session openings
  - Request state management: Handles pending/accepted/rejected states
  - Session isolation: Ensures one active connection per user

- **Camera Permission Handling**: Android permission system
  - Runtime permission requests: CAMERA permission management
  - Permission callbacks: Handles grant/deny responses
  - Graceful degradation: Alternative UI when permission denied

## Plant UML Diagrams

### Class Diagram (MVC Model)

```plantuml
@startuml QR Code Connection Class Diagram

class "Model" as Model {
  - Classes: BarcodeScanner, FirebaseDatabase,
    ConnectionRequestManager
  - Methods: process(), detect(), getInstance(),
    setActiveSessionId(), isValidRequest()
}

class "View" as View {
  - Classes: QRScanActivity, PreviewView,
    TextView, ImageButton
  - Layouts: activity_qr_scan.xml
  - Elements: previewView, buttonBack, textViewScanning
  - Methods: setText(), setVisibility(), show(), requestPermissions()
}

class "Controller" as Controller {
  - Classes: QRScanActivity, ProcessCameraProvider
  - Methods: onCreate(), startCamera(), bindPreview(),
    onActivityResult(), onRequestPermissionsResult()
}

Model --> Controller : provides data
Controller --> View : updates UI
View --> Controller : user input

@enduml
```

### Sequence Diagram

```plantuml
@startuml QR Code Connection Sequence Diagram

actor User
participant QRScanActivity
participant BarcodeScanner
participant FirebaseDatabase
participant ConnectionRequestManager

User -> QRScanActivity: Open QR scanner
QRScanActivity -> QRScanActivity: Request camera permission
User -> QRScanActivity: Grant camera permission
QRScanActivity -> QRScanActivity: Start camera preview
QRScanActivity -> BarcodeScanner: Initialize QR scanner
BarcodeScanner -> QRScanActivity: Ready for scanning

User -> QRScanActivity: Point camera at QR code
BarcodeScanner -> BarcodeScanner: Analyze camera frames
BarcodeScanner -> QRScanActivity: onSuccess(detected QR data)
QRScanActivity -> FirebaseDatabase: Validate QR session ID
FirebaseDatabase --> QRScanActivity: Return connection request data
QRScanActivity -> ConnectionRequestManager: Check active sessions
ConnectionRequestManager --> QRScanActivity: Session available
QRScanActivity -> ConnectChatActivity: Navigate to chat

@enduml
```

### Data Design Diagram

```plantuml
@startuml QR Code Connection Data Design Diagram

database "Firebase Database" as FirebaseDB {
  connection_requests/{requestId} : ConnectionRequest
  connect_chats/{sessionId} : ChatSession
}

class ConnectionRequest {
  +requestId : String <<PK>>
  +senderId : String
  +recipientId : String
  +sessionId : String
  +status : String <<pending/accepted/rejected>>
  +createdAt : timestamp
  +qrData : String
}

class QRCode {
  +data : String
  +sessionId : String <<embedded>>
  +timestamp : long
  +validityPeriod : long = 300000
}

class CameraFrame {
  +image : Image
  +rotationDegrees : int
  +timestamp : long
}

BarcodeScanner --> CameraFrame : analyzes
CameraFrame --> QRCode : extracts data
QRCode --> ConnectionRequest : references

@enduml
```
